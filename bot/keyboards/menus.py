"""
Teclados inline para o bot TeleVIP
"""
from telegram import InlineKeyboardButton, InlineKeyboardMarkup

def get_main_menu() -> InlineKeyboardMarkup:
    """Menu principal do bot"""
    keyboard = [
        [
            InlineKeyboardButton("üìä Minhas Assinaturas", callback_data="check_status"),
            InlineKeyboardButton("üîç Descobrir", callback_data="discover")
        ],
        [
            InlineKeyboardButton("üí∞ Hist√≥rico", callback_data="payment_history"),
            InlineKeyboardButton("‚öôÔ∏è Configura√ß√µes", callback_data="settings")
        ],
        [
            InlineKeyboardButton("‚ùì Ajuda", callback_data="help")
        ]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_plans_menu(plans: list, group_id: int) -> InlineKeyboardMarkup:
    """Menu de sele√ß√£o de planos com destaque para economia"""
    keyboard = []
    
    # Ordenar planos por dura√ß√£o
    sorted_plans = sorted(plans, key=lambda p: p.duration_days)
    
    for i, plan in enumerate(sorted_plans):
        # Calcular economia em planos maiores
        if plan.duration_days == 30:
            emoji = "üìÖ"
            label = "Mensal"
            extra = ""
        elif plan.duration_days == 90:
            emoji = "üíé"
            label = "Trimestral"
            # Calcular economia vs mensal
            monthly_plan = next((p for p in plans if p.duration_days == 30), None)
            if monthly_plan:
                savings = (monthly_plan.price * 3) - plan.price
                if savings > 0:
                    extra = f" (Economia R$ {savings:.2f})"
                else:
                    extra = ""
            else:
                extra = " (Mais popular)"
        elif plan.duration_days == 365:
            emoji = "üëë"
            label = "Anual"
            # Calcular economia vs mensal
            monthly_plan = next((p for p in plans if p.duration_days == 30), None)
            if monthly_plan:
                savings = (monthly_plan.price * 12) - plan.price
                if savings > 0:
                    extra = f" (Economia R$ {savings:.2f})"
                else:
                    extra = ""
            else:
                extra = " (Melhor valor)"
        else:
            emoji = "üìÜ"
            label = f"{plan.duration_days} dias"
            extra = ""
        
        button_text = f"{emoji} {plan.name} - R$ {plan.price:.2f}{extra}"
        
        keyboard.append([
            InlineKeyboardButton(
                button_text,
                callback_data=f"plan_{group_id}_{plan.id}"
            )
        ])
    
    keyboard.append([
        InlineKeyboardButton("‚ùå Cancelar", callback_data="cancel")
    ])
    
    return InlineKeyboardMarkup(keyboard)

def get_payment_keyboard(checkout_data: dict = None) -> InlineKeyboardMarkup:
    """Teclado para op√ß√µes de pagamento"""
    keyboard = [
        [
            InlineKeyboardButton("üí≥ Cart√£o de Cr√©dito", callback_data="pay_stripe")
        ],
        [
            InlineKeyboardButton("üí∞ PIX (Em breve)", callback_data="pay_pix")
        ],
        [
            InlineKeyboardButton("‚ùå Cancelar", callback_data="cancel_payment")
        ]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_cancel_keyboard() -> InlineKeyboardMarkup:
    """Teclado simples com op√ß√£o de cancelar"""
    keyboard = [[
        InlineKeyboardButton("‚ùå Cancelar", callback_data="cancel")
    ]]
    return InlineKeyboardMarkup(keyboard)

def get_renewal_keyboard(subscription_id: int) -> InlineKeyboardMarkup:
    """Teclado para renova√ß√£o de assinatura"""
    keyboard = [[
        InlineKeyboardButton(
            "üîÑ Renovar Agora",
            callback_data=f"renew_{subscription_id}"
        ),
        InlineKeyboardButton(
            "‚è∞ Lembrar Depois",
            callback_data="remind_later"
        )
    ]]
    return InlineKeyboardMarkup(keyboard)

def get_admin_menu() -> InlineKeyboardMarkup:
    """Menu administrativo para criadores"""
    keyboard = [
        [
            InlineKeyboardButton("üìä Estat√≠sticas", callback_data="admin_stats"),
            InlineKeyboardButton("üë• Assinantes", callback_data="admin_subscribers")
        ],
        [
            InlineKeyboardButton("üí∞ Financeiro", callback_data="admin_finance"),
            InlineKeyboardButton("‚öôÔ∏è Configura√ß√µes", callback_data="admin_settings")
        ],
        [
            InlineKeyboardButton("üì¢ Broadcast", callback_data="admin_broadcast"),
            InlineKeyboardButton("üåê Dashboard Web", url="https://televip.com/dashboard")
        ]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_broadcast_confirm_keyboard() -> InlineKeyboardMarkup:
    """Teclado de confirma√ß√£o para broadcast"""
    keyboard = [[
        InlineKeyboardButton("‚úÖ Enviar", callback_data="broadcast_confirm"),
        InlineKeyboardButton("‚ùå Cancelar", callback_data="broadcast_cancel")
    ]]
    return InlineKeyboardMarkup(keyboard)

def get_settings_menu() -> InlineKeyboardMarkup:
    """Menu de configura√ß√µes do usu√°rio"""
    keyboard = [
        [
            InlineKeyboardButton("üîî Notifica√ß√µes", callback_data="settings_notifications"),
            InlineKeyboardButton("üí≥ Pagamentos", callback_data="settings_payments")
        ],
        [
            InlineKeyboardButton("üîê Privacidade", callback_data="settings_privacy"),
            InlineKeyboardButton("üåç Idioma", callback_data="settings_language")
        ],
        [
            InlineKeyboardButton("‚¨ÖÔ∏è Voltar", callback_data="back_to_start")
        ]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_group_settings_menu() -> InlineKeyboardMarkup:
    """Menu de configura√ß√µes do grupo (admin)"""
    keyboard = [
        [
            InlineKeyboardButton("üí∞ Gerenciar Planos", callback_data="settings_plans"),
            InlineKeyboardButton("üìù Editar Descri√ß√£o", callback_data="settings_description")
        ],
        [
            InlineKeyboardButton("üîó Gerar Novo Link", callback_data="settings_link"),
            InlineKeyboardButton("üö´ Pausar Grupo", callback_data="settings_pause")
        ],
        [
            InlineKeyboardButton("üë• Gerenciar Admins", callback_data="settings_admins"),
            InlineKeyboardButton("üìä Relat√≥rios", callback_data="settings_reports")
        ],
        [
            InlineKeyboardButton("‚¨ÖÔ∏è Voltar", callback_data="admin_menu")
        ]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_subscription_actions_keyboard(subscription_id: int, can_renew: bool = True) -> InlineKeyboardMarkup:
    """A√ß√µes dispon√≠veis para uma assinatura"""
    keyboard = []
    
    if can_renew:
        keyboard.append([
            InlineKeyboardButton("üîÑ Renovar", callback_data=f"renew_{subscription_id}"),
            InlineKeyboardButton("üéÅ Presentear", callback_data=f"gift_{subscription_id}")
        ])
    
    keyboard.extend([
        [
            InlineKeyboardButton("üìä Ver Hist√≥rico", callback_data=f"history_{subscription_id}"),
            InlineKeyboardButton("üîî Configurar Alertas", callback_data=f"alerts_{subscription_id}")
        ],
        [
            InlineKeyboardButton("‚¨ÖÔ∏è Voltar", callback_data="check_status")
        ]
    ])
    
    return InlineKeyboardMarkup(keyboard)

def get_discovery_filters_keyboard() -> InlineKeyboardMarkup:
    """Filtros para descoberta de grupos"""
    keyboard = [
        [
            InlineKeyboardButton("üè∑Ô∏è Categorias", callback_data="filter_categories"),
            InlineKeyboardButton("üí∞ Faixa de Pre√ßo", callback_data="filter_price")
        ],
        [
            InlineKeyboardButton("‚≠ê Avalia√ß√£o", callback_data="filter_rating"),
            InlineKeyboardButton("üìÖ Novos", callback_data="filter_new")
        ],
        [
            InlineKeyboardButton("üîÑ Limpar Filtros", callback_data="clear_filters"),
            InlineKeyboardButton("‚¨ÖÔ∏è Voltar", callback_data="discover")
        ]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_back_button(callback_data: str = "back") -> InlineKeyboardMarkup:
    """Bot√£o simples de voltar"""
    return InlineKeyboardMarkup([[
        InlineKeyboardButton("‚¨ÖÔ∏è Voltar", callback_data=callback_data)
    ]])

def get_yes_no_keyboard(yes_callback: str, no_callback: str) -> InlineKeyboardMarkup:
    """Teclado simples Sim/N√£o"""
    return InlineKeyboardMarkup([[
        InlineKeyboardButton("‚úÖ Sim", callback_data=yes_callback),
        InlineKeyboardButton("‚ùå N√£o", callback_data=no_callback)
    ]])

def get_pagination_keyboard(current_page: int, total_pages: int, base_callback: str) -> list:
    """Criar bot√µes de pagina√ß√£o para listas grandes"""
    buttons = []
    
    # Bot√£o anterior
    if current_page > 1:
        buttons.append(
            InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"{base_callback}_page_{current_page-1}")
        )
    
    # N√∫meros de p√°gina (m√°ximo 5)
    start_page = max(1, current_page - 2)
    end_page = min(total_pages + 1, start_page + 5)
    
    for page in range(start_page, end_page):
        if page == current_page:
            buttons.append(
                InlineKeyboardButton(f"‚Ä¢{page}‚Ä¢", callback_data="current_page")
            )
        else:
            buttons.append(
                InlineKeyboardButton(str(page), callback_data=f"{base_callback}_page_{page}")
            )
    
    # Bot√£o pr√≥ximo
    if current_page < total_pages:
        buttons.append(
            InlineKeyboardButton("‚û°Ô∏è", callback_data=f"{base_callback}_page_{current_page+1}")
        )
    
    return buttons

def get_withdrawal_keyboard(available_balance: float) -> InlineKeyboardMarkup:
    """Teclado para solicita√ß√£o de saque"""
    if available_balance < 10.0:
        keyboard = [[
            InlineKeyboardButton(
                f"üí∞ Saldo insuficiente (M√≠n: R$ 10,00)",
                callback_data="insufficient_balance"
            )
        ]]
    else:
        keyboard = [
            [
                InlineKeyboardButton(
                    f"üíµ Sacar R$ {available_balance:.2f}",
                    callback_data="withdraw_all"
                )
            ],
            [
                InlineKeyboardButton("üí∞ Valor Personalizado", callback_data="withdraw_custom"),
                InlineKeyboardButton("üìä Ver Hist√≥rico", callback_data="withdrawal_history")
            ]
        ]
    
    keyboard.append([
        InlineKeyboardButton("‚¨ÖÔ∏è Voltar", callback_data="creator_dashboard")
    ])
    
    return InlineKeyboardMarkup(keyboard)

def get_support_keyboard() -> InlineKeyboardMarkup:
    """Teclado de op√ß√µes de suporte"""
    keyboard = [
        [
            InlineKeyboardButton("üí¨ Chat Suporte", url="https://t.me/televip_suporte"),
            InlineKeyboardButton("üìß Email", callback_data="support_email")
        ],
        [
            InlineKeyboardButton("üìö FAQ", callback_data="support_faq"),
            InlineKeyboardButton("üêõ Reportar Bug", callback_data="support_bug")
        ],
        [
            InlineKeyboardButton("‚¨ÖÔ∏è Voltar", callback_data="help")
        ]
    ]
    return InlineKeyboardMarkup(keyboard)