{% extends "base.html" %}

{% block title %}{{ 'Editar' if group else 'Criar' }} Grupo - TeleVIP{% endblock %}

{% block content %}
<div class="bg-light py-4">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('groups.list') }}">Grupos</a></li>
                <li class="breadcrumb-item active">{{ 'Editar' if group else 'Novo' }} Grupo</li>
            </ol>
        </nav>
    </div>
</div>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Alerta para novos usu√°rios -->
            {% if not group %}
            <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
                <h5 class="alert-heading"><i class="bi bi-info-circle"></i> Primeiro Grupo?</h5>
                <p>Para criar seu primeiro grupo, voc√™ precisar√°:</p>
                <ol class="mb-0">
                    <li>Ter um grupo/canal no Telegram j√° criado</li>
                    <li>Adicionar nosso bot (@televipbra_bot) como administrador</li>
                    <li>Obter o ID do grupo usando o comando /setup</li>
                </ol>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}

            <div class="card">
                <div class="card-header bg-white">
                    <h4 class="mb-0">{{ 'üìù Editar' if group else '‚ûï Criar' }} Grupo</h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('groups.edit', id=group.id) if group else url_for('groups.create') }}">
                        <!-- Informa√ß√µes B√°sicas -->
                        <div class="mb-4">
                            <h5 class="mb-3">Informa√ß√µes B√°sicas</h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Nome do Grupo *</label>
                                <input type="text" name="name" class="form-control" 
                                       value="{{ group.name if group else '' }}" 
                                       placeholder="Ex: Trading VIP, Fitness Premium, Marketing Digital"
                                       required>
                                <small class="text-muted">Este nome aparecer√° para os assinantes</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Descri√ß√£o</label>
                                <textarea name="description" class="form-control" rows="3" 
                                          placeholder="Descreva os benef√≠cios e conte√∫dos exclusivos do seu grupo...">{{ group.description if group else '' }}</textarea>
                                <small class="text-muted">Descreva o conte√∫do e benef√≠cios do grupo</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">ID do Grupo no Telegram *</label>
                                {% if group %}
                                    <input type="text" name="telegram_id" class="form-control" 
                                           value="{{ group.telegram_id }}" readonly>
                                    <small class="text-muted">ID do grupo no Telegram (n√£o pode ser alterado)</small>
                                {% else %}
                                    <input type="text" name="telegram_id" class="form-control" 
                                           placeholder="Ex: -1001234567890"
                                           required>
                                    <small class="text-muted">
                                        <strong>Como obter o ID:</strong>
                                        <ol class="mb-0 ps-3">
                                            <li>Adicione o bot <strong>@televipbra_bot</strong> ao seu grupo</li>
                                            <li>Promova o bot a administrador</li>
                                            <li>Envie o comando <code>/setup</code> no grupo</li>
                                            <li>O bot retornar√° o ID do grupo</li>
                                        </ol>
                                    </small>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Link de Convite do Grupo</label>
                                <div class="alert alert-light">
                                    <i class="bi bi-info-circle"></i>
                                    {% if group %}
                                        <input type="text" name="invite_link" class="form-control mt-2" 
                                               value="{{ group.invite_link if group.invite_link else 'Ser√° gerado automaticamente ao usar /setup' }}"
                                               readonly style="background-color: #f8f9fa;">
                                    {% else %}
                                        O link ser√° gerado automaticamente ap√≥s criar o grupo e executar o comando <code>/setup</code> no Telegram.
                                        <input type="hidden" name="invite_link" value="">
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Planos de Assinatura -->
                        <div class="mb-4">
                            <h5 class="mb-3">Planos de Assinatura</h5>
                            <p class="text-muted">Configure os planos e pre√ßos para seu grupo</p>
                            
                            <div id="plansContainer">
                                {% if group and group.pricing_plans.count() > 0 %}
                                    {% for plan in group.pricing_plans %}
                                    <div class="plan-item border rounded p-3 mb-3">
                                        <div class="row g-2">
                                            <div class="col-md-4">
                                                <label class="form-label">Nome do Plano</label>
                                                <input type="text" name="plan_name[]" class="form-control" 
                                                       value="{{ plan.name }}" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Dura√ß√£o (dias)</label>
                                                <input type="number" name="plan_duration[]" class="form-control" 
                                                       value="{{ plan.duration_days }}" min="1" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Pre√ßo (R$)</label>
                                                <input type="number" name="plan_price[]" class="form-control" 
                                                       value="{{ plan.price }}" step="0.01" min="0.01" required>
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button type="button" class="btn btn-sm btn-danger w-100" 
                                                        onclick="removePlan(this)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <!-- Planos padr√£o para novo grupo -->
                                    <div class="plan-item border rounded p-3 mb-3">
                                        <div class="row g-2">
                                            <div class="col-md-4">
                                                <label class="form-label">Nome do Plano</label>
                                                <input type="text" name="plan_name[]" class="form-control" 
                                                       value="Mensal" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Dura√ß√£o (dias)</label>
                                                <input type="number" name="plan_duration[]" class="form-control" 
                                                       value="30" min="1" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Pre√ßo (R$)</label>
                                                <input type="number" name="plan_price[]" class="form-control" 
                                                       value="29.90" step="0.01" min="0.01" required>
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button type="button" class="btn btn-sm btn-danger w-100" 
                                                        onclick="removePlan(this)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>

                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addPlan()">
                                <i class="bi bi-plus"></i> Adicionar Plano
                            </button>
                            
                            <div class="mt-3">
                                <small class="text-muted">
                                    <strong>Sugest√µes de planos:</strong>
                                    <ul class="mb-0">
                                        <li>Mensal: Plano b√°sico para testar</li>
                                        <li>Trimestral: 10-15% de desconto</li>
                                        <li>Semestral: 15-20% de desconto</li>
                                        <li>Anual: 20-30% de desconto</li>
                                    </ul>
                                </small>
                            </div>
                        </div>

                        <!-- Status -->
                        {% if group %}
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="is_active" 
                                       id="isActive" {{ 'checked' if group.is_active else '' }}>
                                <label class="form-check-label" for="isActive">
                                    Grupo Ativo (aceita novas assinaturas)
                                </label>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Bot√µes -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> {{ 'Salvar Altera√ß√µes' if group else 'Criar Grupo' }}
                            </button>
                            <a href="{{ url_for('groups.list') }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Instru√ß√µes Detalhadas (s√≥ aparece para novos grupos) -->
            {% if not group %}
            <div class="card mt-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üìö Guia Passo a Passo</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-primary">1Ô∏è‚É£ Preparar seu Grupo no Telegram</h6>
                    <ul>
                        <li>Crie um grupo ou canal no Telegram (se ainda n√£o tiver)</li>
                        <li>Configure o grupo como privado</li>
                        <li>Prepare uma mensagem de boas-vindas fixada</li>
                    </ul>

                    <h6 class="text-primary mt-3">2Ô∏è‚É£ Adicionar o Bot</h6>
                    <ul>
                        <li>Procure por <strong>@televipbra_bot</strong> no Telegram</li>
                        <li>Adicione o bot ao seu grupo</li>
                        <li>Promova o bot a administrador com estas permiss√µes:
                            <ul>
                                <li>‚úÖ Adicionar novos membros</li>
                                <li>‚úÖ Remover membros</li>
                                <li>‚úÖ Gerenciar links de convite</li>
                            </ul>
                        </li>
                    </ul>

                    <h6 class="text-primary mt-3">3Ô∏è‚É£ Obter o ID do Grupo</h6>
                    <ul>
                        <li>No grupo, envie o comando: <code>/setup</code></li>
                        <li>O bot responder√° com o ID do grupo (ex: -1001234567890)</li>
                        <li>Copie este ID e cole no campo acima</li>
                    </ul>

                    <h6 class="text-primary mt-3">4Ô∏è‚É£ Finalizar Configura√ß√£o</h6>
                    <ul>
                        <li>Preencha o nome e descri√ß√£o do grupo</li>
                        <li>Configure os planos e pre√ßos</li>
                        <li>Clique em "Criar Grupo"</li>
                        <li>O link de convite ser√° gerado automaticamente</li>
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Sucesso (aparece ap√≥s criar grupo) -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle"></i> Grupo Criado com Sucesso!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                </div>
                
                <h4 id="groupNameSuccess">Seu grupo foi criado!</h4>
                <p class="text-muted">Compartilhe este link com seus seguidores:</p>
                
                <div class="input-group mb-3">
                    <input type="text" class="form-control fw-bold" 
                           id="botLinkSuccess" readonly>
                    <button class="btn btn-primary" type="button"
                            onclick="copyBotLinkModal()">
                        <i class="bi bi-clipboard"></i> Copiar
                    </button>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-lightbulb"></i>
                    <strong>Pr√≥ximos passos:</strong>
                    <ol class="text-start mb-0">
                        <li>Execute o comando <code>/setup</code> no grupo do Telegram</li>
                        <li>Compartilhe o link com seus seguidores</li>
                        <li>Acompanhe as assinaturas pelo dashboard</li>
                    </ol>
                </div>
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('dashboard.index') }}" class="btn btn-secondary">
                    <i class="bi bi-speedometer2"></i> Ir para Dashboard
                </a>
                <a href="{{ url_for('groups.create') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Criar Outro Grupo
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Verificar se deve mostrar modal de sucesso
{% if show_success_modal %}
window.addEventListener('DOMContentLoaded', function() {
    // Preencher dados do modal
    document.getElementById('groupNameSuccess').textContent = 'Grupo "{{ new_group_name }}" criado com sucesso!';
    document.getElementById('botLinkSuccess').value = 'https://t.me/televipbra_bot?start=g_{{ new_group_telegram_id }}';
    
    // Mostrar modal
    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
    successModal.show();
});
{% endif %}

function addPlan() {
    const container = document.getElementById('plansContainer');
    const newPlan = document.createElement('div');
    newPlan.className = 'plan-item border rounded p-3 mb-3 fade-in';
    newPlan.innerHTML = `
        <div class="row g-2">
            <div class="col-md-4">
                <label class="form-label">Nome do Plano</label>
                <input type="text" name="plan_name[]" class="form-control" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Dura√ß√£o (dias)</label>
                <input type="number" name="plan_duration[]" class="form-control" 
                       value="30" min="1" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Pre√ßo (R$)</label>
                <input type="number" name="plan_price[]" class="form-control" 
                       step="0.01" min="0.01" required>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-sm btn-danger w-100" 
                        onclick="removePlan(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.appendChild(newPlan);
}

function removePlan(button) {
    const planItem = button.closest('.plan-item');
    if (document.querySelectorAll('.plan-item').length > 1) {
        planItem.remove();
    } else {
        alert('Voc√™ precisa ter pelo menos um plano!');
    }
}

function copyBotLinkModal() {
    const input = document.getElementById('botLinkSuccess');
    input.select();
    document.execCommand('copy');
    
    // Feedback visual
    const btn = input.nextElementSibling;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i> Copiado!';
    btn.classList.add('btn-success');
    btn.classList.remove('btn-primary');
    
    setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-primary');
    }, 2000);
}
</script>
{% endblock %}