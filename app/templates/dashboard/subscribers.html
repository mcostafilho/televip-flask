{% extends "base.html" %}

{% block title %}Assinantes - {{ group.name }} - TeleVIP{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="dashboard-wrapper subscribers-page">
    <!-- Breadcrumb -->
    <div class="breadcrumb-nav">
        <div class="dashboard-container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('groups.list') }}">Grupos</a></li>
                    <li class="breadcrumb-item">{{ group.name }}</li>
                    <li class="breadcrumb-item active">Assinantes</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header welcome-header">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="welcome-avatar">
                        <i class="bi bi-people-fill" style="font-size: 1.2rem;"></i>
                    </div>
                    <div>
                        <h1 class="h3 mb-1">Assinantes de {{ group.name }}</h1>
                        <p class="text-muted mb-0">Gerencie os assinantes do seu grupo VIP</p>
                    </div>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-sm btn-outline-primary" onclick="exportSubscribers()">
                        <i class="bi bi-download"></i> Exportar
                    </button>
                </div>
            </div>

            <!-- Link de Compartilhamento -->
            <div class="mt-3">
                <label class="form-label text-muted small mb-1">Link de Assinatura:</label>
                <div class="row-link-copy" style="max-width: 480px;">
                    <input type="text" class="form-control form-control-sm"
                           value="https://t.me/{{ config.BOT_USERNAME or 'televipbra_bot' }}?start=g_{{ group.invite_slug }}"
                           id="shareLink" readonly>
                    <button class="btn-copy" type="button" onclick="copyShareLink()" title="Copiar link">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
                <small class="text-muted">Compartilhe para novos assinantes entrarem</small>
            </div>
        </div>

        <!-- Stat Cards -->
        <div class="stats-grid">
            <div class="stat-card stat-primary">
                <div class="d-flex align-items-center">
                    <div class="stat-icon primary"><i class="bi bi-people-fill"></i></div>
                    <div class="ms-3">
                        <p class="text-muted mb-1 small">Total</p>
                        <h3 class="mb-0">{{ stats.total }}</h3>
                    </div>
                </div>
            </div>
            <div class="stat-card stat-success">
                <div class="d-flex align-items-center">
                    <div class="stat-icon success"><i class="bi bi-check-circle-fill"></i></div>
                    <div class="ms-3">
                        <p class="text-muted mb-1 small">Ativos</p>
                        <h3 class="mb-0">{{ stats.active }}</h3>
                    </div>
                </div>
            </div>
            <div class="stat-card stat-warning">
                <div class="d-flex align-items-center">
                    <div class="stat-icon warning"><i class="bi bi-clock-fill"></i></div>
                    <div class="ms-3">
                        <p class="text-muted mb-1 small">Expirando</p>
                        <h3 class="mb-0">{{ stats.expiring_soon }}</h3>
                        <small class="text-muted">próx. 7 dias</small>
                    </div>
                </div>
            </div>
            <div class="stat-card stat-danger">
                <div class="d-flex align-items-center">
                    <div class="stat-icon danger"><i class="bi bi-x-circle-fill"></i></div>
                    <div class="ms-3">
                        <p class="text-muted mb-1 small">Expirados</p>
                        <h3 class="mb-0">{{ stats.expired }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="content-card mb-4" style="padding: 1.25rem 1.5rem;">
            <form method="GET" class="row g-2 align-items-end">
                <div class="col-md-3 col-6">
                    <label class="form-label small mb-1">Status</label>
                    <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="">Todos</option>
                        <option value="active" {{ 'selected' if request.args.get('status') == 'active' }}>Ativos</option>
                        <option value="expired" {{ 'selected' if request.args.get('status') == 'expired' }}>Expirados</option>
                        <option value="cancelled" {{ 'selected' if request.args.get('status') == 'cancelled' }}>Cancelados</option>
                    </select>
                </div>
                <div class="col-md-3 col-6">
                    <label class="form-label small mb-1">Plano</label>
                    <select name="plan_id" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="">Todos</option>
                        {% for plan in group.pricing_plans %}
                        <option value="{{ plan.id }}" {{ 'selected' if request.args.get('plan_id')|int == plan.id }}>
                            {{ plan.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small mb-1">Buscar</label>
                    <input type="text" name="search" class="form-control form-control-sm"
                           placeholder="Username ou ID..."
                           value="{{ request.args.get('search', '') }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-search"></i> Filtrar
                    </button>
                </div>
            </form>
        </div>

        <!-- Lista de Assinantes -->
        <div class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-list"></i> Lista de Assinantes
                </h5>
                {% if subscribers %}
                <small class="text-muted">{{ stats.total }} total</small>
                {% endif %}
            </div>

            {% if subscribers %}
            <div class="row-list">
                {% for sub in subscribers %}
                <div class="row-item">
                    <div class="row-item-left">
                        <!-- Status icon -->
                        {% if sub.status == 'active' and sub.end_date >= now %}
                            {% if (sub.end_date - now).days <= 7 %}
                            <div class="row-icon pending">
                                <i class="bi bi-clock"></i>
                            </div>
                            {% else %}
                            <div class="row-icon completed">
                                <i class="bi bi-check-lg"></i>
                            </div>
                            {% endif %}
                        {% elif sub.status == 'cancelled' %}
                        <div class="row-icon inactive">
                            <i class="bi bi-slash-circle"></i>
                        </div>
                        {% else %}
                        <div class="row-icon failed">
                            <i class="bi bi-x-lg"></i>
                        </div>
                        {% endif %}

                        <div class="row-info">
                            <div class="row-title">
                                @{{ sub.telegram_username or 'Sem username' }}
                                {% if sub.status == 'active' and sub.end_date >= now and (sub.end_date - now).days > 7 %}
                                    <span class="glow-dot green"></span>
                                {% elif sub.status == 'active' and sub.end_date >= now %}
                                    <span class="glow-dot yellow"></span>
                                {% endif %}
                            </div>
                            <div class="row-sub">
                                {{ sub.plan.name }} &middot; R$ {{ "%.2f"|format(sub.plan.price) }}
                                &middot; ID: {{ sub.telegram_user_id }}
                            </div>
                        </div>
                    </div>

                    <div class="row-item-right">
                        <div class="row-metrics">
                            <div class="row-metric">
                                <span class="row-metric-value" style="color: var(--galactic-text-bright); font-size: 0.82rem;">
                                    {{ sub.start_date.strftime('%d/%m/%y') }}
                                </span>
                                <span class="row-metric-label">início</span>
                            </div>
                            <div class="row-metric">
                                {% if sub.status == 'active' and sub.end_date > now %}
                                <span class="row-metric-value {% if (sub.end_date - now).days <= 7 %}yellow{% else %}green{% endif %}" style="font-size: 0.82rem;">
                                    {{ (sub.end_date - now).days }}d restantes
                                </span>
                                {% else %}
                                <span class="row-metric-value" style="color: var(--galactic-danger); font-size: 0.82rem;">
                                    {{ sub.end_date.strftime('%d/%m/%y') }}
                                </span>
                                {% endif %}
                                <span class="row-metric-label">expira</span>
                            </div>
                        </div>
                        <div class="row-actions">
                            <button class="row-action-btn" onclick="viewDetails({{ sub.id }})" title="Detalhes">
                                <i class="bi bi-eye"></i>
                            </button>
                            {% if sub.status == 'active' %}
                            <form method="POST"
                                  action="{{ url_for('groups.subscribers', id=group.id) }}"
                                  style="display: inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit"
                                        class="row-action-btn"
                                        style="color: var(--galactic-danger);"
                                        onclick="return confirm('Cancelar assinatura de @{{ sub.telegram_username }}?')"
                                        title="Cancelar">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Paginação -->
            {% if total_pages > 1 %}
            <div class="pagination-wrapper">
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page - 1 }}&{{ request.query_string.decode() }}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}

                        {% for p in range(1, total_pages + 1) %}
                            {% if p == page %}
                            <li class="page-item active">
                                <span class="page-link">{{ p }}</span>
                            </li>
                            {% elif p == 1 or p == total_pages or (p > page - 3 and p < page + 3) %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ p }}&{{ request.query_string.decode() }}">{{ p }}</a>
                            </li>
                            {% elif p == page - 3 or p == page + 3 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page + 1 }}&{{ request.query_string.decode() }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}

            {% else %}
            <div class="empty-state-v2">
                <div class="empty-icon"><i class="bi bi-people"></i></div>
                <h4>Nenhum assinante encontrado</h4>
                <p>
                    {% if request.args.get('search') or request.args.get('status') or request.args.get('plan_id') %}
                        Tente ajustar os filtros de busca
                    {% else %}
                        Este grupo ainda não tem assinantes
                    {% endif %}
                </p>
            </div>
            {% endif %}
        </div>

        <!-- Ações -->
        <div class="quick-actions mt-4" style="max-width: 480px; margin-left: auto; margin-right: auto;">
            <a href="{{ url_for('groups.broadcast', group_id=group.id) }}" class="qa-tile">
                <div class="qa-icon" style="background: rgba(124, 92, 252, 0.15); color: #7c5cfc;">
                    <i class="bi bi-broadcast"></i>
                </div>
                <span>Mensagem</span>
            </a>
            <a href="{{ url_for('groups.edit', id=group.id) }}" class="qa-tile">
                <div class="qa-icon" style="background: rgba(56, 189, 248, 0.15); color: #38bdf8;">
                    <i class="bi bi-gear-fill"></i>
                </div>
                <span>Configurações</span>
            </a>
            <a href="{{ url_for('groups.list') }}" class="qa-tile">
                <div class="qa-icon" style="background: rgba(255, 255, 255, 0.06); color: var(--galactic-text-secondary);">
                    <i class="bi bi-arrow-left"></i>
                </div>
                <span>Voltar</span>
            </a>
        </div>
    </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Assinante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function copyShareLink() {
    const input = document.getElementById('shareLink');
    input.select();
    navigator.clipboard.writeText(input.value).then(function() {
        const btn = input.nextElementSibling;
        const orig = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i>';
        btn.style.color = '#34d399';
        setTimeout(() => { btn.innerHTML = orig; btn.style.color = ''; }, 2000);
    });
}

function exportSubscribers() {
    window.location.href = "{{ url_for('groups.export_subscribers', id=group.id) }}";
}

function viewDetails(subId) {
    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    modal.show();
    fetch(`/groups/{{ group.id }}/subscribers/${subId}/details`)
        .then(response => response.text())
        .then(html => {
            document.querySelector('#detailsModal .modal-body').innerHTML = html;
        })
        .catch(error => {
            document.querySelector('#detailsModal .modal-body').innerHTML =
                '<div class="alert alert-danger">Erro ao carregar detalhes</div>';
        });
}
</script>
{% endblock %}
