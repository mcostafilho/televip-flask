{% extends "base.html" %}

{% block title %}Detalhes: {{ creator.name }} - Admin TeleVIP{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="dashboard-container">
        <!-- Breadcrumb -->
        <div class="breadcrumb-nav">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin.index') }}">Admin</a></li>
                    <li class="breadcrumb-item active">{{ creator.name }}</li>
                </ol>
            </nav>
        </div>

        <!-- Creator Header -->
        <div class="dashboard-header welcome-header">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="welcome-avatar">
                        <i class="bi bi-person-circle" style="font-size: 1.3rem;"></i>
                    </div>
                    <div>
                        <h1 class="h3 mb-1">{{ creator.name }}</h1>
                        <p class="text-muted mb-0">
                            {{ creator.email }} &middot; @{{ creator.username }}
                            &middot; Telegram: {{ creator.telegram_id or 'Nao configurado' }}
                            &middot; Cadastro: {{ creator.created_at.strftime('%d/%m/%Y %H:%M') }}
                        </p>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('admin.view_creator_dashboard', creator_id=creator.id) }}"
                       class="btn btn-sm btn-primary" style="border-radius: 20px;">
                        <i class="bi bi-speedometer2"></i> Ver Dashboard
                    </a>
                    <a href="{{ url_for('admin.index') }}"
                       class="btn btn-sm btn-outline-secondary" style="border-radius: 20px;">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>
        </div>

        <!-- Stat Cards -->
        <div class="stats-grid">
            <div class="stat-card stat-primary">
                <div class="d-flex align-items-center">
                    <div class="stat-icon primary"><i class="bi bi-collection"></i></div>
                    <div class="ms-3">
                        <p class="text-muted mb-1 small">Grupos</p>
                        <h3 class="mb-0">{{ stats.total_groups }}</h3>
                    </div>
                </div>
            </div>
            <div class="stat-card stat-info">
                <div class="d-flex align-items-center">
                    <div class="stat-icon info"><i class="bi bi-people"></i></div>
                    <div class="ms-3">
                        <p class="text-muted mb-1 small">Assinantes Ativos</p>
                        <h3 class="mb-0">{{ stats.active_subscribers }}</h3>
                    </div>
                </div>
            </div>
            <div class="stat-card stat-success">
                <div class="d-flex align-items-center">
                    <div class="stat-icon success"><i class="bi bi-cash-stack"></i></div>
                    <div class="ms-3">
                        <p class="text-muted mb-1 small">Receita Total</p>
                        <h3 class="mb-0">R$ {{ "%.2f"|format(stats.total_revenue) }}</h3>
                    </div>
                </div>
            </div>
            <div class="stat-card stat-warning">
                <div class="d-flex align-items-center">
                    <div class="stat-icon warning"><i class="bi bi-hourglass-split"></i></div>
                    <div class="ms-3">
                        <p class="text-muted mb-1 small">Saque Pendente</p>
                        <h3 class="mb-0">R$ {{ "%.2f"|format(stats.pending_withdrawal) }}</h3>
                    </div>
                </div>
            </div>
            <div class="stat-card" style="border-left: 3px solid var(--galactic-success);">
                <div class="d-flex align-items-center">
                    <div class="stat-icon" style="background: rgba(52, 211, 153, 0.12); color: var(--galactic-success);"><i class="bi bi-wallet2"></i></div>
                    <div class="ms-3">
                        <p class="text-muted mb-1 small">Disponivel p/ Saque</p>
                        <h3 class="mb-0" style="color: var(--galactic-success);">R$ {{ "%.2f"|format(stats.withdrawable_balance) }}</h3>
                    </div>
                </div>
            </div>
            <div class="stat-card" style="border-left: 3px solid var(--galactic-warning);">
                <div class="d-flex align-items-center">
                    <div class="stat-icon" style="background: rgba(251, 191, 36, 0.12); color: var(--galactic-warning);"><i class="bi bi-lock"></i></div>
                    <div class="ms-3">
                        <p class="text-muted mb-1 small">Bloqueado (7 dias)</p>
                        <h3 class="mb-0" style="color: var(--galactic-warning);">R$ {{ "%.2f"|format(stats.blocked_balance) }}</h3>
                    </div>
                </div>
            </div>
            <div class="stat-card" style="border-left: 3px solid var(--galactic-accent-2);">
                <div class="d-flex align-items-center">
                    <div class="stat-icon" style="background: rgba(56, 189, 248, 0.12); color: var(--galactic-accent-2);"><i class="bi bi-graph-up-arrow"></i></div>
                    <div class="ms-3">
                        <p class="text-muted mb-1 small">Total Ganho (liquido)</p>
                        <h3 class="mb-0" style="color: var(--galactic-accent-2);">R$ {{ "%.2f"|format(stats.total_earned_net) }}</h3>
                    </div>
                </div>
            </div>
            <div class="stat-card" style="border-left: 3px solid var(--galactic-danger);">
                <div class="d-flex align-items-center">
                    <div class="stat-icon" style="background: rgba(248, 113, 113, 0.12); color: var(--galactic-danger);"><i class="bi bi-arrow-up-circle"></i></div>
                    <div class="ms-3">
                        <p class="text-muted mb-1 small">Total Sacado</p>
                        <h3 class="mb-0" style="color: var(--galactic-danger);">R$ {{ "%.2f"|format(stats.total_withdrawn) }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Taxas Personalizadas -->
        <div class="content-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-percent"></i> Taxas
                </h5>
                <div class="d-flex gap-2 align-items-center">
                    {% if creator.custom_fixed_fee is not none or creator.custom_percentage_fee is not none %}
                        <span class="badge bg-primary">Personalizado</span>
                    {% elif fee_rates.tier_info and fee_rates.tier_info.subscriber_count > 1000 %}
                        <span class="badge" style="background: rgba(56, 189, 248, 0.2); color: var(--galactic-accent-2);">
                            <i class="bi bi-graph-down-arrow"></i>
                            Faixa: {{ fee_rates.tier_info.subscriber_count | int }} assinantes &rarr; {{ fee_rates.tier_info.percentage_display }}
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">Padrao</span>
                    {% endif %}
                </div>
            </div>
            <form method="POST" action="{{ url_for('admin.update_creator_fees', creator_id=creator.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="use_custom_fees" name="use_custom_fees"
                           {% if creator.custom_fixed_fee is not none or creator.custom_percentage_fee is not none %}checked{% endif %}
                           onchange="toggleCustomFees(this)">
                    <label class="form-check-label" for="use_custom_fees">Usar taxas personalizadas</label>
                </div>
                <div id="custom-fees-fields" style="{% if creator.custom_fixed_fee is none and creator.custom_percentage_fee is none %}display:none{% endif %}">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="custom_fixed_fee" class="form-label">Taxa fixa (R$)</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="custom_fixed_fee"
                                   name="custom_fixed_fee"
                                   value="{{ '%.2f'|format(creator.custom_fixed_fee) if creator.custom_fixed_fee is not none else '%.2f'|format(fee_defaults.fixed) }}"
                                   placeholder="{{ '%.2f'|format(fee_defaults.fixed) }}">
                            <small class="form-text">Padrao: R$ {{ '%.2f'|format(fee_defaults.fixed) }}</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="custom_percentage_fee" class="form-label">Taxa percentual (%)</label>
                            <input type="number" step="0.01" min="0" max="100" class="form-control" id="custom_percentage_fee"
                                   name="custom_percentage_fee"
                                   value="{{ '%.2f'|format(creator.custom_percentage_fee * 100) if creator.custom_percentage_fee is not none else '%.2f'|format(fee_defaults.percentage) }}"
                                   placeholder="{{ '%.2f'|format(fee_defaults.percentage) }}">
                            <small class="form-text">Padrao: {{ '%.2f'|format(fee_defaults.percentage) }}%</small>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="border-radius: 10px;">
                    <i class="bi bi-save"></i> Salvar Taxas
                </button>
            </form>

            <!-- Tabela de faixas escalonadas -->
            <div class="mt-4 pt-3" style="border-top: 1px solid rgba(255,255,255,0.06);">
                <h6 class="mb-2" style="font-size: 0.85rem;">
                    <i class="bi bi-bar-chart-steps"></i> Faixas Escalonadas por Assinantes
                </h6>
                <p class="text-muted mb-2" style="font-size: 0.75rem;">
                    Taxa percentual automática quando não há taxa personalizada. Taxa fixa (R$ 0,99) não muda.
                </p>
                <table class="table table-sm mb-0" style="font-size: 0.8rem;">
                    <thead>
                        <tr>
                            <th style="border-color: rgba(255,255,255,0.06);">Assinantes</th>
                            <th style="border-color: rgba(255,255,255,0.06);">Taxa</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set tiers = [
                            ('0 - 1.000', '9,99%', '9,99%'),
                            ('1.001 - 5.000', '8,99%', '8,99%'),
                            ('5.001 - 15.000', '7,99%', '7,99%'),
                            ('15.001 - 50.000', '6,99%', '6,99%'),
                            ('50.001+', '5,99%', '5,99%')
                        ] %}
                        {% set active_pct = fee_rates.tier_info.percentage_display if fee_rates.tier_info and not (creator.custom_fixed_fee is not none or creator.custom_percentage_fee is not none) else none %}
                        {% for label, pct, match_pct in tiers %}
                        <tr {% if active_pct and active_pct == match_pct %}style="background: rgba(56, 189, 248, 0.08); font-weight: 600;"{% endif %}>
                            <td style="border-color: rgba(255,255,255,0.06);">{{ label }}</td>
                            <td style="border-color: rgba(255,255,255,0.06);">{{ pct }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Grupos -->
        <div class="content-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-telegram"></i> Grupos
                </h5>
                <span class="badge bg-primary">{{ groups|length }}</span>
            </div>

            {% if groups %}
            <div class="row-list">
                {% for group in groups %}
                <div class="row-item">
                    <div class="row-item-left">
                        <div class="row-icon {% if group.is_active %}active{% else %}inactive{% endif %}">
                            {% if group.is_active %}
                                <i class="bi bi-telegram"></i>
                            {% else %}
                                <i class="bi bi-pause-circle"></i>
                            {% endif %}
                        </div>
                        <div class="row-info">
                            <div class="row-title">
                                {{ group.name }}
                                {% if group.is_active %}
                                    <span class="badge bg-success" style="font-size: 0.65rem;">Ativo</span>
                                {% else %}
                                    <span class="badge bg-secondary" style="font-size: 0.65rem;">Inativo</span>
                                {% endif %}
                            </div>
                            <div class="row-sub">
                                <code style="background: rgba(124, 92, 252, 0.15); color: var(--galactic-accent-2); padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.72rem;">{{ group.telegram_id }}</code>
                            </div>
                        </div>
                    </div>
                    <div class="row-item-right">
                        <div class="row-metrics">
                            <div class="row-metric">
                                <span class="row-metric-value cyan">{{ group.subscriptions.filter_by(status='active').count() }}</span>
                                <span class="row-metric-label">assinantes</span>
                            </div>
                            <div class="row-metric">
                                <span class="row-metric-value green">{{ group.pricing_plans.count() }}</span>
                                <span class="row-metric-label">planos</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state-v2">
                <div class="empty-icon"><i class="bi bi-collection"></i></div>
                <p class="text-muted mb-0">Nenhum grupo criado ainda</p>
            </div>
            {% endif %}
        </div>

        <!-- Transacoes Recentes -->
        <div class="content-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> Transacoes Recentes
                </h5>
            </div>

            {% if recent_transactions %}
            <div class="row-list">
                {% for transaction in recent_transactions %}
                <div class="row-item">
                    <div class="row-item-left">
                        <div class="row-icon {% if transaction.status == 'completed' %}completed{% else %}pending{% endif %}">
                            {% if transaction.status == 'completed' %}
                                <i class="bi bi-check-lg"></i>
                            {% else %}
                                <i class="bi bi-clock"></i>
                            {% endif %}
                        </div>
                        <div class="row-info">
                            <div class="row-title">
                                {{ transaction.subscription.group.name }}
                                <span class="tx-status-badge {{ transaction.status }}">
                                    {% if transaction.status == 'completed' %}
                                        <i class="bi bi-check-circle-fill"></i> Pago
                                    {% else %}
                                        <i class="bi bi-clock-fill"></i> {{ transaction.status }}
                                    {% endif %}
                                </span>
                            </div>
                            <div class="row-sub">
                                @{{ transaction.subscription.telegram_username }}
                                &middot; {{ transaction.created_at.strftime('%d/%m/%Y %H:%M') }}
                            </div>
                        </div>
                    </div>
                    <div class="row-item-right">
                        <div class="tx-amount green">R$ {{ "%.2f"|format(transaction.amount) }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state-v2">
                <div class="empty-icon"><i class="bi bi-clock-history"></i></div>
                <p class="text-muted mb-0">Nenhuma transacao ainda</p>
            </div>
            {% endif %}
        </div>

        <!-- Saques Pendentes -->
        {% if pending_withdrawals %}
        <div class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i> Saques Pendentes
                </h5>
                <span class="badge bg-warning">{{ pending_withdrawals|length }}</span>
            </div>

            <div class="row-list">
                {% for withdrawal in pending_withdrawals %}
                <div class="row-item">
                    <div class="row-item-left">
                        <div class="row-icon pending">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="row-info">
                            <div class="row-title">
                                R$ {{ "%.2f"|format(withdrawal.amount) }}
                            </div>
                            <div class="row-sub">
                                <code style="background: rgba(124, 92, 252, 0.15); color: var(--galactic-accent-2); padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.72rem;">{{ withdrawal.pix_key }}</code>
                                &middot; {{ withdrawal.created_at.strftime('%d/%m/%Y %H:%M') }}
                            </div>
                        </div>
                    </div>
                    <div class="row-item-right">
                        <div class="tx-amount yellow">R$ {{ "%.2f"|format(withdrawal.amount) }}</div>
                        <form method="POST" action="{{ url_for('admin.process_withdrawal', id=withdrawal.id) }}" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-sm btn-success"
                                    onclick="return confirm('Confirma que o PIX foi realizado?')">
                                <i class="bi bi-check-circle"></i> Pago
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleCustomFees(checkbox) {
    document.getElementById('custom-fees-fields').style.display = checkbox.checked ? '' : 'none';
}
</script>
{% endblock %}
